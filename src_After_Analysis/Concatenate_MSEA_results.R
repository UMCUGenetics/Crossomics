#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Info --------------------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

# This script uses the MSEA_results.RData files generated by GeneMetabMapper.R to generate a data table of all runs and patients, 
# which can be used by the Prioritised_gene_anlaysis.R script for visualisation.

# R version:  3.6.1 (2019-07-05)
# platform:   x86_64-apple-darwin15.6.0 (64-bit)
# OS:         macOS Mojave 10.14.6
# 
# libraries:
# rstudioapi    0.10
# data.table    1.12.6
# Matrix        1.2-17
# Matrix.utils  0.9.7




#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Libraries ---------------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

library("rstudioapi")
library("Matrix.utils")
library("data.table")
library("stringr")



#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Set variables -----------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

code_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
Z_thresholds <- c("1.5, -1", "2, -1.5", "3, -3", "5, -5")
max_rxns <- c(8, 10, 12, 15, 17, 19)
steps <- c(0,1,2,3,4,5)
date <- "2019-12-04"
seed_date <- "2019-10-22"
seeds <- sub(x = list.files(path = paste0(code_dir, "/../Results/Mock_genes/",seed_date,"/")),
             pattern = ".*seed([^seed]*?)\\.txt",
             replacement = "\\1")
seeds <- as.numeric(seeds[!grepl("[a-z]", seeds)])
patient_info_file <- "Crossomics_DBS_Marten_trimmed20191205.RData"



#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Prepare data ------------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

load(paste0(code_dir,"/../Data/", patient_info_file))

xls_data$Gene <- str_replace_all(xls_data$Gene, " ", "")

# get only 1 row per patient (including patients with more than 1 ID)
xls_unique <- xls_data[!duplicated(xls_data$file_patientIDs),]
xls_unique <- xls_unique[unlist(lapply(xls_unique$file_patientIDs, function(x) length(grep(x, xls_unique$file_patientIDs)) == 1)),]

xls_unique$nr_disease_genes <- unlist(lapply(xls_unique$Gene, function(x) length(unlist(strsplit(x, split = ";")))))

xls_unique <- as.data.table(xls_unique)
xls_unique[, Patient.collated := str_replace_all(paste(Patient, Patient.Iden, Patient.Iden2, Patient.Iden3, sep = ";"), pattern = ";NA", replacement = "")]


#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Collate data into 1 Data table ------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

follow_nr <- 1
setresults <- list()
for (i in 1:nrow(xls_unique)){

  patient <- xls_unique$Patient.collated[i]
  cat("Patient:",patient,"\n")
  path <- paste(code_dir,"../Results",date, xls_unique$file_patientIDs[i], sep = "/")

  for(seed in seeds){
    
    # Check if patient was included in the seed, continue to next one otherwise
    if(!dir.exists(paste0(path,"/seed",seed))) {
      cat("patient - seed combination does not exist:", patient, seed, "\n")
      next
    }
    path2 <- paste0(path,"/seed",seed,"/MSEA_results.RData")
    load(path2)
    Patient_metSetResult[, Top5_Gene_P.val := as.character(Top5_Gene_P.val)]

    setresults[[follow_nr]] <- Patient_metSetResult
    
    follow_nr <- follow_nr + 1
  }
}

DT <- dplyr::bind_rows(setresults)

DT[ , c("Rank.frac", "Rev.Rank.frac") := list(Position/Last_position, 1-((Position-1)/(Last_position-1))) ]
DT[, Z_threshold:=factor(Z_threshold, levels = Z_thresholds)]
DT[, Max_rxn:=factor(Max_rxn, levels = max_rxns)]
DT[, Step:=factor(Step, levels = steps)]

saveRDS(DT, file = paste0(code_dir,"/../Results/",date,"/MSEA_DT_compiled_all.RDS"))

