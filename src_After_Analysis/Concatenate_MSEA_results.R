#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Info --------------------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

# This script uses the MSEA_results.RData files generated by GeneMetabMapper.R to generate a data table of all runs and patients, 
# which can be used by the Prioritised_gene_anlaysis.R script for visualisation.

# R version:  3.6.1 (2019-07-05)
# platform:   x86_64-apple-darwin15.6.0 (64-bit)
# OS:         macOS Mojave 10.14.6
# 
# libraries:
# rstudioapi    0.10
# data.table    1.12.6
# Matrix        1.2-17
# Matrix.utils  0.9.7




#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Libraries ---------------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

library("rstudioapi")
library("Matrix.utils")
library("data.table")
library("stringr")



#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Set variables -----------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

code_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
date <- "2019-12-10"
seed_date <- "2019-12-10"
seeds <- sub(x = list.files(path = paste0(code_dir, "/../Results/Mock_genes/",seed_date,"/")),
             pattern = ".*seed([^seed]*?)\\.txt",
             replacement = "\\1")
seeds <- as.numeric(seeds[!grepl("[a-z]", seeds)])
patient_info_file <- "Crossomics_DBS_Marten_trimmed20191205.RData"

# These patients have multiple possible disease genes. It is declared here which gene is taken as true disease gene.
patient_gene_combinations <- data.frame("PatientID" = c("P286^RES_DBS_20181001_Run1_Algoritmetest_1", 
                                                        "P268^RES_DBS_20181001_Run1_Algoritmetest_1", 
                                                        "P013^2017_008_MetabolomicsDiagnosis_RUN1_1", 
                                                        "P190^RES_DBS_20181001_Run1_Algoritmetest_1"),
                                        "Gene" = c("MMACHC", "IDH2", "BCKDHA", "ETFDH"), 
                                        stringsAsFactors = FALSE)



#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Prepare data ------------------------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

load(paste0(code_dir,"/../Data/", patient_info_file))

xls_data$Gene <- str_replace_all(xls_data$Gene, " ", "")

# get only 1 row per patient (including patients with more than 1 ID)
xls_unique <- xls_data[!duplicated(xls_data$file_patientIDs),]
xls_unique <- xls_unique[unlist(lapply(xls_unique$file_patientIDs, function(x) length(grep(x, xls_unique$file_patientIDs)) == 1)),]

xls_unique$nr_disease_genes <- unlist(lapply(xls_unique$Gene, function(x) length(unlist(strsplit(x, split = ";")))))

xls_unique <- as.data.table(xls_unique)
xls_unique[, Patient.collated := str_replace_all(paste(Patient, Patient.Iden, Patient.Iden2, Patient.Iden3, sep = ";"), pattern = ";NA", replacement = "")]


#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Collate data into 1 Data table ------------------------------------------
#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

follow_nr <- 1
setresults <- list()
for (i in 1:nrow(xls_unique)){

  patient <- xls_unique$Patient.collated[i]
  cat("Patient:",patient,"\n")
  path <- paste(code_dir,"../Results",date, xls_unique$file_patientIDs[i], sep = "/")

  for(seed in seeds){
    
    # Check if patient was included in the seed, continue to next one otherwise
    if(!dir.exists(paste0(path,"/seed",seed))) {
      cat("patient - seed combination does not exist:", patient, seed, "\n")
      next
    }
    path2 <- paste0(path,"/seed",seed,"/MSEA_results.RData")
    load(path2)
    Patient_metSetResult[, Top5_Gene_P.val := as.character(Top5_Gene_P.val)]

    setresults[[follow_nr]] <- Patient_metSetResult
    
    follow_nr <- follow_nr + 1
  }
}

DT <- data.table(dplyr::bind_rows(setresults))

DT[Z_threshold == "1.5, -1", Z_threshold := "-1, 1.5" ]
DT[Z_threshold == "2, -1.5", Z_threshold := "-1.5, 2" ]
DT[Z_threshold == "3, -3", Z_threshold := "-3, 3" ]
DT[Z_threshold == "5, -5", Z_threshold := "-5, 5" ]

mycolumns = c("Z_threshold", "Max_rxn", "Step", "Rank.frac", "Rev.Rank.frac")
DT[ , (mycolumns) := list(factor(Z_threshold), factor(Max_rxn), factor(Step), Position/Last_position, 1-((Position-1)/(Last_position-1)))]

DT[, Include := TRUE]
for(i in c(1:nrow(patient_gene_combinations))){
  tmpPat <- grepl(patient_gene_combinations$PatientID[i], DT$PatientID, fixed = TRUE)
  tmpGen <- !grepl(patient_gene_combinations$Gene[i], DT$Gene, fixed = TRUE)
  tmp <- tmpPat & tmpGen
  DT[ tmp, Include := FALSE]
}

DT[, Missed := P.value == 1]



saveRDS(DT, file = paste0(code_dir,"/../Results/",date,"/MSEA_DT_compiled_all.RDS"))

# handy to save a simple text file here as well with all the disease genes that are actually used.
