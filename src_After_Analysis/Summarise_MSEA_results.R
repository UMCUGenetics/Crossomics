###########################################################################
# Info --------------------------------------------------------------------
###########################################################################

# This script uses the MSEA_results.RData files generated by GeneMetabMapper.R to generate a data table of all runs and patients, 
# which can be used by the Prioritised_gene_anlaysis.R script for visualisation.

# R version:  3.6.0 (2019-04-26)
# platform:   x86_64-apple-darwin15.6.0 (64-bit)
# OS:         macOS Mojave 10.14.6
# 
# libraries:
# rstudioapi    0.10
# data.table    1.12.2
# Matrix        1.2-17
# Matrix.utils  0.9.7




###########################################################################
# Libraries ---------------------------------------------------------------
###########################################################################

library("rstudioapi")
library("Matrix.utils")
library("data.table")
library("stringr") # for patient digit fixing

# library("XLConnect") # Only for older results. Switched to .RData files
# library("xlsx")


###########################################################################
# Set variables -----------------------------------------------------------
###########################################################################

code_dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
Z_thresholds <- c("-1, 1.5", "-1.5, 2", "-3, 3", "-5, 5")
max_rxns <- c(8, 10, 12, 15, 17, 19)
steps <- c(0,1,2,3,4,5)
date <- "2019-09-11"
seeds <- c(8372, 2528, 6140, 3880, 2771, 
           8455, 3200, 6250, 4860, 6297, 
           244, 3764, 2464, 3218, 2282, 
           5600, 2359, 8353, 6399, 2001)
patient_info_file <- "Crossomics_DBS_Marten_Training_Validation.RData"
patients_not_done <- NULL # in format c("P38.1", "P39.1","P40.1")
trainingset <- TRUE


###########################################################################
# Prepare data ------------------------------------------------------------
###########################################################################

load(paste0(code_dir,"/../Data/", patient_info_file))
# xls_data <- xlsx::read.xlsx(paste0(code_dir,"/../Data/Crossomics_DBS_Marten_Training_inclProt_function.xlsx"), sheetIndex = 1, colIndex = c(1:7), rowIndex = c(1:107), stringsAsFactors = FALSE)
# save(xls_data, file = paste0(code_dir,"/../Data/Crossomics_DBS_Marten_Training_inclProt_function.RData"))

if("Patient number in set" %in% colnames(xls_data)){
  xls_data$Patient <- unlist(lapply(xls_data$`Patient number in set`, function(x) unlist(strsplit(x, split = "\\."))[1]))
} else if ("Patient.number" %in% colnames(xls_data)){
  xls_data$Patient <- unlist(lapply(xls_data$Patient.number, function(x) unlist(strsplit(x, split = "\\."))[1]))
} else {
  stop("column names of xls_data do not follow a known pattern")
}

# columns to paste together
# cols <- c( 'Dataset' , 'Patient' )

# create a new column `x` with the three columns collapsed together
xls_unique <- xls_data[!duplicated(apply( xls_data[ , c( 'Dataset' , 'Patient' ) ] , 1 , paste , collapse = "_" )),]

# Fix numbering of patients to contain 3 digits
xls_unique[,Patient := lapply(xls_unique[,Patient], function(x) paste0("P",str_pad(unlist(strsplit(x, split = "P"))[2], 3, side = "left", pad = "0")))]

# fixed_patients <- unlist(lapply(strsplit(xls_unique$Patient[nchar(xls_unique$Patient) <= 3], split = ""), function(x) paste0(x[1],"0",x[2])))
# xls_unique$Patient[nchar(xls_unique$Patient) == 2] <- fixed_patients

# Remove patients/disease genes who are artifacts
xls_unique <- xls_unique[Gene != "NA",]

# select test set or validation set & only non-exlusion patients
which_set <- ifelse(trainingset == TRUE, "Training set", "Validation set")
xls_unique <- xls_unique[`Type set` == which_set & (is.na(xls_unique[,`Judith:`]) | `Judith:` == "Inclusion"),]
xls_unique <- as.data.table(xls_unique)

DT <- NULL

###########################################################################
# Collate results to 1 data table -----------------------------------------
###########################################################################

for (i in 1:nrow(xls_unique)){
  patient <- unlist(xls_unique[i, Patient])
  prot_func <- xls_unique$Gene.product.function[i]
  if(is.null(prot_func)) prot_func <- NA
  if (length(patients_not_done) > 0){
    if(xls_unique$Patient.number[i] %in% patients_not_done) next
  }
  cat("Patient:",patient,"\n")
  dis_gene <- xls_unique$Gene[i]
  dis_gene <- unlist(strsplit(dis_gene, split = "; "))
  is_trans <- xls_unique$Gene.product.function[i] == "transporter"
  if(length(is_trans) == 0) is_trans <- NA
  patient_folder <- paste0(date,"/", patient, "_",xls_unique$Dataset[i])
  # patient_folder <- paste0(date,"_MSEA_results/", patient, "_",xls_unique$Dataset[i])
  path <- paste0(code_dir,"/../Results/",patient_folder)
  
  for(seed in seeds){
    
    # Check if patient was included in the seed, continue to next one otherwise
    if(!dir.exists(paste0(path,"/seed",seed))) next
    
    for(maxrxn in max_rxns){
      
      for(threshs in Z_thresholds){
        
        thresh <- unlist(strsplit(threshs, ", "))
        
        for(step in steps){
          
          # path2 <- paste0(path,"/maxrxn",maxrxn,"_thresh_n",thresh[1],"_p",thresh[2],"_step_",step,"/MSEA_results.xls")
          # # if(!file.exists(path2)) path2 <- paste0(path,"/maxrxn",maxrxn,"thresh_n",thresh[1],"_p",thresh[2],"_step_",step,"/MSEA_results.xls")
          # # MSEA_results <- read.xlsx(path2, sheetIndex = 1)
          # wb <- loadWorkbook(path2)
          # MSEA_results <- readWorksheet(wb, sheet = 1, startRow = 0, endRow = 0, startCol = 0, endCol = 0)
          
          path2 <- paste0(path,"/seed",seed,"/maxrxn",maxrxn,"_thresh_n",thresh[1],"_p",thresh[2],"_step_",step,"/MSEA_results.RData")
          load(path2)
          MSEA_results <- metSetResult
          
          # Take the best scoring (possible) disease gene (when more than 1 is present) or a 'last place' when it is absent or p.val = 1
          if(any(dis_gene %in% MSEA_results$metabolite.set)){
            # dis_pos <- min(unlist(lapply(dis_gene, function(x) grep(x, MSEA_results$metabolite.set))))
            dis_pos <- min(unlist(lapply(dis_gene, function(x) grep(paste0("\\b",x,"\\b"), MSEA_results$metabolite.set))))
            
            p.value <- MSEA_results$p.value[dis_pos]
            if(p.value==1){
              rank <- nrow(MSEA_results)
            } else {
              rank <- frank(as.numeric(MSEA_results$p.value))[dis_pos]
            }
          } else {
            # dis_pos <- nrow(MSEA_results)
            rank <- nrow(MSEA_results)
            p.value <- 1
          }
          # dis_pos <- grep(dis_gene, MSEA_results$metabolite.set)
          
          gene_set <- nrow(MSEA_results)
          
          patient_DT <- data.table(Patient = patient,
                                   Gene = paste(dis_gene,collapse = ";"),
                                   Protein_function = prot_func,
                                   Transporter = is_trans,
                                   Position = rank,
                                   Total_genes = gene_set,
                                   # Rev_Pos_frac = 1-((dis_pos-1)/(gene_set-1)),
                                   Rev_Pos_frac = 1-((rank-1)/(gene_set-1)),
                                   # Pos_frac = dis_pos/gene_set,
                                   Pos_frac = rank/gene_set,
                                   Z_threshold = threshs,
                                   Step = step,
                                   Max_rxn = maxrxn,
                                   P.value = p.value,
                                   Seed = seed)
          
          ###########################################################################
          # Make datatable of all patients ------------------------------------------
          ###########################################################################
          
          DT <- rbind(DT, patient_DT)
          
        }
      }
    }
  }
}

# DT$Z_threshold_order <- factor(DT$Z_threshold, levels = Z_thresholds)
DT[, Z_threshold:=factor(Z_threshold, levels = Z_thresholds)]
DT[, Max_rxn:=factor(Max_rxn, levels = max_rxns)]
DT[, Step:=factor(Step, levels = steps)]
DT[, Protein_function:=as.factor(Protein_function)]

if(trainingset){
  saveRDS(DT, file = paste0(code_dir,"/../Results/",date,"/MSEA_DT_compiled_trainingset.RDS"))
} else {
  saveRDS(DT, file = paste0(code_dir,"/../Results/",date,"/MSEA_DT_compiled_validationset.RDS"))
}

